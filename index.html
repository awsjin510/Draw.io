<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AWS æ¶æ§‹åœ–ç”¢ç”Ÿå™¨ | Powered by Claude AI</title>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --accent: #FF9900;
      --accent-hover: #e88800;
      --accent-glow: rgba(255,153,0,0.2);
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --border: #30363d;
      --code-bg: #0d1117;
      --success: #3fb950;
      --error: #f85149;
      --warning: #d29922;
      --info: #58a6ff;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 38px; height: 38px;
      background: linear-gradient(135deg, #FF9900, #e05c00);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .logo-text h1 { font-size: 17px; font-weight: 700; }
    .logo-text p { font-size: 12px; color: var(--text-secondary); }
    .header-badge {
      font-size: 11px; padding: 3px 10px;
      background: var(--accent-glow); border: 1px solid rgba(255,153,0,0.4);
      border-radius: 20px; color: var(--accent);
    }

    /* â”€â”€ Layout â”€â”€ */
    .container {
      max-width: 1440px; margin: 0 auto; padding: 24px;
      display: grid; grid-template-columns: 520px 1fr; gap: 20px;
    }
    @media (max-width: 1000px) { .container { grid-template-columns: 1fr; } }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 18px;
    }
    .card + .card { margin-top: 16px; }
    .card-title {
      font-size: 11px; font-weight: 700; color: var(--text-secondary);
      text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 14px;
      display: flex; align-items: center; gap: 6px;
    }

    /* â”€â”€ Form Elements â”€â”€ */
    label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500; }
    input[type="password"], input[type="text"], select, textarea {
      width: 100%; background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 13px; color: var(--text-primary);
      font-size: 14px; transition: border-color 0.2s;
    }
    input[type="password"]:focus, input[type="text"]:focus,
    select:focus, textarea:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    select { cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%238b949e' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px;
    }
    textarea { resize: vertical; min-height: 150px; line-height: 1.6; font-size: 14px; }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      padding: 9px 16px; border-radius: 8px; border: none; cursor: pointer;
      font-size: 13px; font-weight: 600; transition: all 0.15s; white-space: nowrap;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
    .btn-primary:disabled { background: #2d3748; color: #4a5568; cursor: not-allowed; }
    .btn-outline {
      background: transparent; border: 1px solid var(--border); color: var(--text-primary);
    }
    .btn-outline:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
    .btn-outline:disabled { color: var(--text-secondary); cursor: not-allowed; opacity: 0.5; }
    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover:not(:disabled) { color: var(--text-primary); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    /* â”€â”€ API Key Row â”€â”€ */
    .input-row { display: flex; gap: 8px; }
    .input-row input { flex: 1; }
    .key-hint { font-size: 11px; color: var(--text-secondary); margin-top: 6px; }

    /* â”€â”€ Warning Banner â”€â”€ */
    .warning-box {
      background: rgba(210,153,34,0.08); border: 1px solid rgba(210,153,34,0.25);
      border-radius: 8px; padding: 10px 13px; font-size: 12px; color: #c9962b; margin-top: 10px;
      line-height: 1.5;
    }

    /* â”€â”€ Status Badge â”€â”€ */
    .status-msg {
      display: flex; align-items: center; gap: 7px;
      padding: 9px 13px; border-radius: 8px; font-size: 13px; margin-top: 10px;
    }
    .status-msg.success { background: rgba(63,185,80,0.08); border: 1px solid rgba(63,185,80,0.25); color: #3fb950; }
    .status-msg.error { background: rgba(248,81,73,0.08); border: 1px solid rgba(248,81,73,0.25); color: #f85149; }
    .status-msg.info { background: rgba(88,166,255,0.08); border: 1px solid rgba(88,166,255,0.25); color: #58a6ff; }
    .status-msg.warning { background: rgba(210,153,34,0.08); border: 1px solid rgba(210,153,34,0.25); color: #d29922; }

    /* â”€â”€ Examples Grid â”€â”€ */
    .examples-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .example-chip {
      padding: 9px 12px; background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-secondary); font-size: 12px;
      cursor: pointer; text-align: left; transition: all 0.15s; line-height: 1.5;
    }
    .example-chip strong { display: block; color: var(--text-primary); font-size: 13px; margin-bottom: 2px; }
    .example-chip:hover { border-color: var(--accent); color: var(--text-primary); background: rgba(255,153,0,0.04); }

    /* â”€â”€ Generate Button â”€â”€ */
    .generate-btn {
      width: 100%; padding: 14px 20px; font-size: 15px; font-weight: 700;
      background: linear-gradient(135deg, #FF9900, #e06800);
      color: #000; border: none; border-radius: 10px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s; margin-top: 16px;
    }
    .generate-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(255,153,0,0.35);
    }
    .generate-btn:disabled {
      background: #1c2128; color: #4a5568; cursor: not-allowed;
      transform: none; box-shadow: none; border: 1px solid var(--border);
    }

    /* â”€â”€ Output Panel â”€â”€ */
    .output-panel { display: flex; flex-direction: column; }
    .output-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 12px; padding: 18px;
      display: flex; flex-direction: column;
      min-height: calc(100vh - 100px);
    }
    .output-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 14px; flex-wrap: wrap; gap: 8px;
    }
    .output-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* â”€â”€ Progress â”€â”€ */
    .progress-bar {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      background: rgba(255,153,0,0.06); border: 1px solid rgba(255,153,0,0.2);
      border-radius: 8px; font-size: 13px; color: var(--accent); margin-bottom: 12px;
    }
    .spinner {
      width: 18px; height: 18px; flex-shrink: 0;
      border: 2px solid rgba(255,153,0,0.3); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.75s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-chars { margin-left: auto; font-size: 12px; color: var(--text-secondary); }

    /* â”€â”€ XML Output â”€â”€ */
    .xml-output {
      flex: 1; background: var(--code-bg); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px;
      font-family: 'Cascadia Code', 'Fira Code', 'Courier New', monospace;
      font-size: 12px; line-height: 1.7; color: #e6edf3;
      white-space: pre-wrap; word-break: break-all;
      overflow-y: auto; min-height: 400px;
    }
    .xml-output.placeholder {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; text-align: center;
      color: var(--text-secondary); font-family: inherit; font-size: 14px; gap: 10px;
    }
    .xml-output.placeholder .ph-icon { font-size: 48px; }
    .xml-output.placeholder .ph-sub { font-size: 12px; color: #555; }

    /* â”€â”€ Token Info â”€â”€ */
    .token-info { font-size: 11px; color: var(--text-secondary); text-align: right; margin-top: 8px; }

    /* â”€â”€ Divider â”€â”€ */
    .divider { height: 1px; background: var(--border); margin: 14px 0; }

    /* â”€â”€ XML Syntax Highlight (simple) â”€â”€ */
    .xml-tag { color: #7ee787; }
    .xml-attr { color: #79c0ff; }
    .xml-value { color: #a5d6ff; }
    .xml-comment { color: #8b949e; font-style: italic; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">âš¡</div>
    <div class="logo-text">
      <h1>AWS æ¶æ§‹åœ–ç”¢ç”Ÿå™¨</h1>
      <p>AWS Architecture Diagram Generator Â· Powered by Claude AI</p>
    </div>
  </div>
  <span class="header-badge">Beta v0.1</span>
</header>

<div class="container">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• Left: Input Panel â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="input-panel">

    <!-- API Key -->
    <div class="card">
      <div class="card-title">ğŸ”‘ API é‡‘é‘°è¨­å®š</div>
      <label for="apiKeyInput">Anthropic API Key</label>
      <div class="input-row">
        <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." autocomplete="off" />
        <button class="btn btn-outline" onclick="validateApiKey()">é©—è­‰</button>
        <button class="btn btn-primary" onclick="saveApiKey()">å„²å­˜</button>
      </div>
      <p class="key-hint">é‡‘é‘°æ ¼å¼ï¼šsk-ant-â€¦ &nbsp;|&nbsp; <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent);">å‰å¾€å–å¾—</a></p>
      <div id="apiKeyStatus"></div>
      <div class="warning-box">
        âš ï¸ é‡‘é‘°åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ localStorageï¼Œä¸å‚³é€è‡³ä»»ä½•ä¼ºæœå™¨ã€‚<br>
        è«‹å‹¿åœ¨å…±ç”¨é›»è…¦ä¸Šä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œä»¥é˜²é‡‘é‘°æ´©éœ²ã€‚
      </div>
    </div>

    <!-- Model -->
    <div class="card">
      <div class="card-title">âš™ï¸ æ¨¡å‹è¨­å®š</div>
      <label for="modelSelect">Claude æ¨¡å‹</label>
      <select id="modelSelect">
        <option value="claude-sonnet-4-6" selected>claude-sonnet-4-6ï¼ˆæ¨è–¦ï¼‰</option>
        <option value="claude-opus-4-6">claude-opus-4-6ï¼ˆæœ€å¼·ï¼‰</option>
        <option value="claude-haiku-4-5-20251001">claude-haiku-4-5-20251001ï¼ˆå¿«é€Ÿï¼‰</option>
        <option value="claude-3-5-sonnet-20241022">claude-3-5-sonnet-20241022</option>
        <option value="claude-3-5-haiku-20241022">claude-3-5-haiku-20241022ï¼ˆæœ€å¿«ï¼‰</option>
      </select>
    </div>

    <!-- Description -->
    <div class="card">
      <div class="card-title">ğŸ“ æ¶æ§‹æè¿°</div>
      <label for="descriptionInput">ç”¨è‡ªç„¶èªè¨€æè¿°æ‚¨çš„ AWS æ¶æ§‹éœ€æ±‚</label>
      <textarea id="descriptionInput" placeholder="ä¾‹å¦‚ï¼šå»ºç«‹ä¸€å€‹é«˜å¯ç”¨çš„é›»å•†å¹³å°ï¼Œéœ€è¦ CloudFront CDNã€ALB è² è¼‰å‡è¡¡ã€EC2 Auto Scaling Groupã€RDS Aurora Multi-AZã€ElastiCache Redisï¼Œéƒ¨ç½²åœ¨ ap-northeast-1ï¼ˆæ±äº¬ï¼‰ï¼Œéœ€ç¬¦åˆ Well-Architected Framework..."></textarea>

      <div class="divider"></div>
      <div class="card-title">ğŸ’¡ å¿«é€Ÿç¯„ä¾‹</div>
      <div class="examples-grid">
        <button class="example-chip" onclick="setExample(0)">
          <strong>ğŸ›’ é›»å•†å¹³å°</strong>CDN + ALB + EC2 ASG + RDS Multi-AZ
        </button>
        <button class="example-chip" onclick="setExample(1)">
          <strong>âš¡ Serverless API</strong>API Gateway + Lambda + DynamoDB
        </button>
        <button class="example-chip" onclick="setExample(2)">
          <strong>ğŸ—ï¸ å¾®æœå‹™æ¶æ§‹</strong>ECS Fargate + SQS + SNS + RDS
        </button>
        <button class="example-chip" onclick="setExample(3)">
          <strong>ğŸ“Š è³‡æ–™åˆ†æå¹³å°</strong>Kinesis + S3 + Glue + Athena
        </button>
      </div>
    </div>

    <!-- Generate Button -->
    <button id="generateBtn" class="generate-btn" onclick="generateDiagram()">
      <span id="genIcon">âš¡</span>
      <span id="genText">ç”Ÿæˆ AWS æ¶æ§‹åœ–</span>
    </button>

    <div id="genStatus"></div>

  </div><!-- end input-panel -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• Right: Output Panel â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="output-panel">
    <div class="output-card">

      <div class="output-header">
        <div class="card-title" style="margin-bottom:0">ğŸ“„ ç”Ÿæˆçš„ draw.io XML</div>
        <div class="output-actions">
          <button id="btnCopy"    class="btn btn-outline btn-sm" onclick="copyXML()"        disabled>è¤‡è£½ XML</button>
          <button id="btnPreview" class="btn btn-outline btn-sm" onclick="previewInDrawio()" disabled>åœ¨ draw.io é è¦½</button>
          <button id="btnDL"      class="btn btn-primary btn-sm" onclick="downloadDrawio()"  disabled>â¬‡ ä¸‹è¼‰ .drawio</button>
        </div>
      </div>

      <div id="progressBar" class="progress-bar" style="display:none;">
        <div class="spinner"></div>
        <span>æ­£åœ¨ç”Ÿæˆæ¶æ§‹åœ–â€¦</span>
        <span id="charCount" class="progress-chars">0 å­—å…ƒ</span>
      </div>

      <div id="xmlOutput" class="xml-output placeholder">
        <div class="ph-icon">ğŸ—‚ï¸</div>
        <div>æ¶æ§‹åœ– XML å°‡é¡¯ç¤ºæ–¼æ­¤</div>
        <div class="ph-sub">è¨­å®š API é‡‘é‘° â†’ è¼¸å…¥æ¶æ§‹éœ€æ±‚ â†’ é»æ“Šã€Œç”Ÿæˆã€</div>
      </div>

      <div id="tokenInfo" class="token-info"></div>

    </div>
  </div><!-- end output-panel -->

</div><!-- end container -->

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Constants
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½ AWS è³‡æ·±è§£æ±ºæ–¹æ¡ˆæ¶æ§‹å¸«ï¼Œå°ˆç²¾æ–¼è¨­è¨ˆç¬¦åˆ AWS Well-Architected Framework å…­å¤§æ”¯æŸ±çš„é›²ç«¯æ¶æ§‹ã€‚

ä½ çš„ä»»å‹™æ˜¯å°‡ä½¿ç”¨è€…çš„éœ€æ±‚è½‰æ›ç‚º draw.io XML æ ¼å¼çš„ AWS æ¶æ§‹åœ–ã€‚

ã€çµ•å°ç¦æ­¢ã€‘
- ç¦æ­¢è¼¸å‡ºä»»ä½•èªªæ˜æ–‡å­—ã€å‰è¨€ã€çµèª
- ç¦æ­¢ä½¿ç”¨ markdown èªæ³•ï¼ˆç¦æ­¢ \`\`\`xmlã€\`\`\` ç­‰ä»£ç¢¼å¡Šï¼‰
- ç¦æ­¢è¼¸å‡º XML ä»¥å¤–çš„ä»»ä½•å…§å®¹
- ä½ çš„å›æ‡‰å¿…é ˆç›´æ¥ä»¥ <mxfile é–‹é ­ï¼Œä¸å¾—æœ‰ä»»ä½•å‰ç¶´æ–‡å­—

ã€XML è·³è„«è¦å‰‡ â€” åš´æ ¼éµå®ˆï¼Œé•åå°‡å°è‡´æª”æ¡ˆç„¡æ³•é–‹å•Ÿã€‘
- æ‰€æœ‰ XML å±¬æ€§å€¼ä¸­çš„ç‰¹æ®Šå­—å…ƒå¿…é ˆæ­£ç¢ºè·³è„«ï¼š
  & â†’ &amp;   < â†’ &lt;   > â†’ &gt;   " â†’ &quot;   ' â†’ &apos;
- ç¯„ä¾‹ï¼šlabel="EC2 &amp; RDS"ï¼ˆæ­£ç¢ºï¼‰  label="EC2 & RDS"ï¼ˆéŒ¯èª¤ï¼æœƒå°è‡´è§£æå¤±æ•—ï¼‰
- style å±¬æ€§ä¸­çš„åˆ†è™Ÿ ; ä¸éœ€è¦è·³è„«ï¼ˆé‚£æ˜¯ draw.io çš„åˆ†éš”ç¬¦ï¼‰ï¼Œä½† & ä»éœ€å¯«æˆ &amp;
- value / label å±¬æ€§ä¸­è‹¥åŒ…å« HTMLï¼Œå…§éƒ¨çš„å¼•è™Ÿå¿…é ˆç”¨ &quot; è·³è„«
- åš´ç¦åœ¨ä»»ä½•å±¬æ€§å€¼ä¸­ä½¿ç”¨æœªè·³è„«çš„ & < > " å­—å…ƒ

ã€æ¶æ§‹è¦å‰‡ã€‘
1. è¼¸å‡ºå®Œæ•´çš„ <mxfile> XMLï¼Œçµæ§‹å®Œæ•´å¯ç›´æ¥åœ¨ diagrams.net / draw.io æ¡Œé¢ç‰ˆé–‹å•Ÿ
2. ä½¿ç”¨ mxgraph.aws4.* å®˜æ–¹åœ–ç¤ºï¼ˆshape=mxgraph.aws4.resourceIcon; resIcon=mxgraph.aws4.xxxï¼‰
3. åŒ…å«ï¼šVPC å®¹å™¨ã€è‡³å°‘ 2 å€‹ AZã€Public/Private/Isolated Subnet åˆ†å±¤
4. æ¯å€‹å…ƒä»¶æ¨™ç¤ºæœå‹™åç¨±èˆ‡è¦æ ¼ï¼ˆt3.mediumã€db.r6g.large ç­‰ï¼‰
5. ä½ˆå±€ç”±ä¸Šåˆ°ä¸‹ï¼šInternet â†’ CloudFront/WAF â†’ Public Subnetï¼ˆALB, NAT GWï¼‰â†’ Private Subnet â†’ Isolated Subnetï¼ˆDBï¼‰
6. é€£ç·šç®­é ­éœ€æ¨™ç¤ºå”å®š/Portï¼ˆHTTPS:443ã€MySQL:3306ï¼‰
7. åŒ…å« CloudWatch ç›£æ§
8. æ‰€æœ‰ mxCell id å¿…é ˆå”¯ä¸€ï¼Œparent="1" ç‚ºæ ¹å±¤ç´š

ã€å¿…é ˆå®Œæˆçš„ XML çµæ§‹ã€‘
<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" type="device" version="21.6.5">
  <diagram name="AWS Architecture" id="aws-arch">
    <mxGraphModel dx="1654" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        [åœ¨æ­¤æ”¾ç½®æ‰€æœ‰ AWS å…ƒä»¶çš„ mxCell]
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>`;

const EXAMPLES = [
  {
    title: 'é«˜å¯ç”¨é›»å•†å¹³å°',
    desc: `å»ºç«‹ä¸€å€‹é«˜å¯ç”¨çš„é›»å•†å¹³å°ï¼Œéƒ¨ç½²åœ¨ ap-northeast-1ï¼ˆæ±äº¬ï¼‰ï¼Œéœ€ç¬¦åˆ AWS Well-Architected Frameworkï¼š

æ¶æ§‹éœ€æ±‚ï¼š
- å‰ç«¯ CDNï¼šCloudFront + S3 éœæ…‹è³‡æº + ACM æ†‘è­‰
- å®‰å…¨é˜²è­·ï¼šWAF + AWS Shield Standard
- è² è¼‰å‡è¡¡ï¼šApplication Load Balancerï¼ˆè·¨ 2 å€‹ AZï¼‰
- æ‡‰ç”¨å±¤ï¼šEC2 Auto Scaling Groupï¼ˆt3.mediumï¼‰ï¼Œéƒ¨ç½²åœ¨ Private Subnet
- å¿«å–å±¤ï¼šElastiCache Redisï¼ˆr6g.largeï¼Œä¸»å¾æ¶æ§‹ï¼‰
- è³‡æ–™åº«ï¼šRDS Aurora MySQL Multi-AZï¼ˆdb.r6g.largeï¼‰
- è¨Šæ¯ä½‡åˆ—ï¼šSQSï¼ˆè¨‚å–®è™•ç†ç•°æ­¥åŒ–ï¼‰
- éœæ…‹è³‡æºï¼šS3 + CloudFront
- ç›£æ§ï¼šCloudWatch Dashboards + CloudTrail
- ç¶²è·¯ï¼šVPCï¼ˆ10.0.0.0/16ï¼‰ï¼Œ2 å€‹ AZï¼ŒPublic/Private/Isolated Subnetï¼ŒNAT Gateway`
  },
  {
    title: 'Serverless API',
    desc: `è¨­è¨ˆä¸€å€‹å®Œå…¨ Serverless çš„ REST API å¾Œç«¯æœå‹™ï¼š

æ¶æ§‹éœ€æ±‚ï¼š
- API å…¥å£ï¼šAPI Gatewayï¼ˆREST APIï¼‰+ è‡ªè¨‚ç¶²åŸŸ + CloudFront
- èªè­‰æˆæ¬Šï¼šAmazon Cognito User Pool + JWT Token
- æ¥­å‹™é‚è¼¯ï¼šAWS Lambdaï¼ˆNode.js 20.xï¼Œå¤šå€‹ Functionï¼‰
- ä¸»è¦è³‡æ–™åº«ï¼šDynamoDBï¼ˆOn-demandï¼ŒGlobal Tableï¼‰
- é—œè¯è³‡æ–™ï¼šRDS Aurora Serverless v2ï¼ˆPostgreSQLï¼‰
- ç‰©ä»¶å„²å­˜ï¼šS3ï¼ˆä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆï¼Œé ç°½å URLï¼‰
- äº‹ä»¶é©…å‹•ï¼šEventBridge + SQS + SNS
- ç§˜å¯†ç®¡ç†ï¼šSecrets Manager
- å¯è§€æ¸¬æ€§ï¼šCloudWatch Logs + X-Ray åˆ†æ•£å¼è¿½è¹¤`
  },
  {
    title: 'å¾®æœå‹™å®¹å™¨å¹³å°',
    desc: `è¨­è¨ˆåŸºæ–¼å®¹å™¨çš„å¾®æœå‹™æ¶æ§‹ï¼ŒåŒ…å«è¨‚å–®ã€åº«å­˜ã€é€šçŸ¥ä¸‰å€‹æ ¸å¿ƒæœå‹™ï¼š

æ¶æ§‹éœ€æ±‚ï¼š
- å®¹å™¨å¹³å°ï¼šECS Fargateï¼ˆå¤š AZï¼Œå„æœå‹™ç¨ç«‹ Task Definitionï¼‰
- æµé‡å…¥å£ï¼šApplication Load Balancerï¼ˆè·¯å¾‘è·¯ç”±åˆ°å„å¾®æœå‹™ï¼‰
- æœå‹™ç™¼ç¾ï¼šAWS Cloud Map
- è¨Šæ¯åŒ¯æµæ’ï¼šAmazon SQSï¼ˆæœå‹™é–“è§£è€¦ï¼‰+ SNSï¼ˆäº‹ä»¶å»£æ’­ï¼‰
- è¨‚å–®æœå‹™ DBï¼šRDS PostgreSQL Multi-AZï¼ˆdb.t3.mediumï¼‰
- åº«å­˜æœå‹™ DBï¼šDynamoDBï¼ˆOn-demandï¼‰
- å¿«å–ï¼šElastiCache Redisï¼ˆä¾›æ‰€æœ‰æœå‹™å…±ç”¨ï¼‰
- å®¹å™¨æ˜ åƒï¼šAmazon ECR
- ç›£æ§ï¼šCloudWatch Container Insights + X-Ray`
  },
  {
    title: 'å¤§æ•¸æ“šåˆ†æå¹³å°',
    desc: `å»ºç«‹æ¯æ—¥è™•ç† TB ç´šè³‡æ–™çš„å¤§æ•¸æ“šåˆ†æå¹³å°ï¼š

æ¶æ§‹éœ€æ±‚ï¼š
- è³‡æ–™æ”¶é›†ï¼šAmazon Kinesis Data Streamsï¼ˆå³æ™‚ä¸²æµï¼‰+ AWS DMSï¼ˆè³‡æ–™åº«é·ç§»ï¼‰
- è³‡æ–™è¼¸é€ï¼šKinesis Data Firehoseï¼ˆâ†’S3 è‡ªå‹•åˆ†å±¤ï¼‰
- è³‡æ–™æ¹–åˆ†å±¤ï¼šS3 ä¸‰å±¤æ¶æ§‹ï¼ˆRaw/Processed/Curatedï¼‰
- ETL è™•ç†ï¼šAWS Glueï¼ˆSpark Jobï¼‰+ Glue Data Catalog
- äº’å‹•æŸ¥è©¢ï¼šAmazon Athenaï¼ˆç„¡ä¼ºæœå™¨ SQLï¼‰
- è³‡æ–™å€‰å„²ï¼šAmazon Redshiftï¼ˆra3.xlplusï¼Œç”¨æ–¼ BI å ±è¡¨ï¼‰
- è¦–è¦ºåŒ–ï¼šAmazon QuickSightï¼ˆé€£æ¥ Athena + Redshiftï¼‰
- ä»»å‹™æ’ç¨‹ï¼šApache Airflow on MWAA
- ç›£æ§ï¼šCloudWatch + AWS Glue è³‡æ–™å“è³ª`
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let generatedXML = '';
let isGenerating = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('anthropic-api-key');
  if (saved) {
    document.getElementById('apiKeyInput').value = saved;
    showApiStatus('å·²è¼‰å…¥å„²å­˜çš„ API é‡‘é‘°', 'success');
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  API Key
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { showApiStatus('è«‹è¼¸å…¥ API é‡‘é‘°', 'error'); return; }
  localStorage.setItem('anthropic-api-key', key);
  showApiStatus('âœ“ å·²å„²å­˜è‡³æœ¬åœ°ç€è¦½å™¨', 'success');
}

async function validateApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { showApiStatus('è«‹è¼¸å…¥ API é‡‘é‘°', 'error'); return; }
  showApiStatus('é©—è­‰ä¸­â€¦', 'info');
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-3-haiku-20240307',
        max_tokens: 10,
        messages: [{ role: 'user', content: 'Hi' }]
      })
    });
    if (res.ok) {
      showApiStatus('âœ“ API é‡‘é‘°æœ‰æ•ˆï¼å·²è‡ªå‹•å„²å­˜', 'success');
      localStorage.setItem('anthropic-api-key', key);
    } else {
      const err = await res.json().catch(() => ({}));
      showApiStatus(`âœ— é©—è­‰å¤±æ•—ï¼š${err.error?.message || res.statusText}`, 'error');
    }
  } catch (e) {
    showApiStatus(`âœ— ç¶²è·¯éŒ¯èª¤ï¼š${e.message}`, 'error');
  }
}

function showApiStatus(msg, type) {
  const el = document.getElementById('apiKeyStatus');
  el.innerHTML = `<div class="status-msg ${type}">${msg}</div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Examples
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setExample(idx) {
  document.getElementById('descriptionInput').value = EXAMPLES[idx].desc;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Generate
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateDiagram() {
  if (isGenerating) return;

  const key = localStorage.getItem('anthropic-api-key')
    || document.getElementById('apiKeyInput').value.trim();
  const desc = document.getElementById('descriptionInput').value.trim();
  const model = document.getElementById('modelSelect').value;

  if (!key) { showGenStatus('è«‹å…ˆè¨­å®šä¸¦å„²å­˜ API é‡‘é‘°', 'error'); return; }
  if (!desc) { showGenStatus('è«‹è¼¸å…¥æ¶æ§‹æè¿°', 'warning'); return; }

  isGenerating = true;
  generatedXML = '';

  // UI: loading state
  const btn = document.getElementById('generateBtn');
  document.getElementById('genIcon').textContent = '';
  document.getElementById('genText').textContent = 'ç”Ÿæˆä¸­â€¦';
  btn.disabled = true;

  setOutputButtons(true); // disabled
  document.getElementById('tokenInfo').textContent = '';
  document.getElementById('progressBar').style.display = 'flex';
  document.getElementById('charCount').textContent = '0 å­—å…ƒ';

  const xmlOut = document.getElementById('xmlOutput');
  xmlOut.className = 'xml-output';
  xmlOut.textContent = '';
  showGenStatus('', '');

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'content-type': 'application/json',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model,
        max_tokens: 8192,
        stream: true,
        system: SYSTEM_PROMPT,
        messages: [
          { role: 'user', content: desc }
        ]
      })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || `HTTP ${res.status} ${res.statusText}`);
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let inputTokens = 0, outputTokens = 0;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const raw = line.slice(6).trim();
        if (!raw || raw === '[DONE]') continue;
        try {
          const ev = JSON.parse(raw);
          if (ev.type === 'message_start') {
            inputTokens = ev.message?.usage?.input_tokens ?? 0;
          } else if (ev.type === 'content_block_delta' && ev.delta?.type === 'text_delta') {
            generatedXML += ev.delta.text;
            xmlOut.textContent = generatedXML;
            xmlOut.scrollTop = xmlOut.scrollHeight;
            document.getElementById('charCount').textContent = `${generatedXML.length} å­—å…ƒ`;
          } else if (ev.type === 'message_delta') {
            outputTokens = ev.usage?.output_tokens ?? 0;
          }
        } catch (_) {}
      }
    }

    // Success â€” clean and validate
    document.getElementById('progressBar').style.display = 'none';
    document.getElementById('tokenInfo').textContent =
      `Token æ¶ˆè€—ï¼šè¼¸å…¥ ${inputTokens} + è¼¸å‡º ${outputTokens} = å…± ${inputTokens + outputTokens}`;

    const cleaned = cleanXML(generatedXML);
    const { valid, error: xmlErr } = validateXML(cleaned);

    // Show cleaned XML in output box
    const xmlOut2 = document.getElementById('xmlOutput');
    xmlOut2.className = 'xml-output';
    xmlOut2.textContent = cleaned || generatedXML;

    setOutputButtons(false); // enabled

    if (valid) {
      showGenStatus('âœ“ æ¶æ§‹åœ–ç”Ÿæˆå®Œæˆï¼ŒXML é©—è­‰é€šéï¼å¯ä¸‹è¼‰æˆ–åœ¨ draw.io é è¦½', 'success');
    } else {
      showGenStatus(`âš ï¸ XML é©—è­‰è­¦å‘Šï¼š${xmlErr}ã€‚è‹¥ä¸‹è¼‰å¾Œç„¡æ³•é–‹å•Ÿï¼Œè«‹é»ã€Œé‡æ–°ç”Ÿæˆã€`, 'warning');
    }

  } catch (err) {
    document.getElementById('progressBar').style.display = 'none';
    xmlOut.className = 'xml-output placeholder';
    xmlOut.innerHTML = `<div class="ph-icon">âš ï¸</div><div style="color:var(--error)">ç”Ÿæˆå¤±æ•—</div><div class="ph-sub">${escHtml(err.message)}</div>`;
    showGenStatus(`âœ— éŒ¯èª¤ï¼š${err.message}`, 'error');
  } finally {
    isGenerating = false;
    btn.disabled = false;
    document.getElementById('genIcon').textContent = 'âš¡';
    document.getElementById('genText').textContent = 'ç”Ÿæˆ AWS æ¶æ§‹åœ–';
  }
}

function setOutputButtons(disabled) {
  ['btnCopy','btnPreview','btnDL'].forEach(id => {
    document.getElementById(id).disabled = disabled;
  });
}

function showGenStatus(msg, type) {
  const el = document.getElementById('genStatus');
  el.innerHTML = msg ? `<div class="status-msg ${type}" style="margin-top:12px">${escHtml(msg)}</div>` : '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  XML Processing
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Strip markdown fences and extract only the <mxfile>...</mxfile> block.
 * Falls back to wrapping <mxGraphModel> if <mxfile> is missing.
 * Also applies XML sanitization to fix common AI-generated errors.
 */
function cleanXML(raw) {
  // 1. Remove markdown code fences  (```xml ... ``` or ``` ... ```)
  let text = raw
    .replace(/^```(?:xml|XML)?\s*\r?\n?/gm, '')
    .replace(/\r?\n?```\s*$/gm, '');

  let xml = '';

  // 2. Extract <mxfile ...> ... </mxfile>
  const mxStart = text.indexOf('<mxfile');
  const mxEnd   = text.lastIndexOf('</mxfile>');
  if (mxStart !== -1 && mxEnd !== -1) {
    xml = text.slice(mxStart, mxEnd + 9).trim();
  } else {
    // 3. Fallback: find <mxGraphModel> and wrap it in a proper mxfile shell
    const gmStart = text.indexOf('<mxGraphModel');
    const gmEnd   = text.lastIndexOf('</mxGraphModel>');
    if (gmStart !== -1 && gmEnd !== -1) {
      const inner = text.slice(gmStart, gmEnd + 15);
      xml = `<mxfile host="app.diagrams.net" type="device" version="21.6.5">` +
            `<diagram name="AWS Architecture" id="aws-arch">${inner}</diagram></mxfile>`;
    } else {
      // 4. Nothing recognisable found â€” return trimmed text as-is
      xml = text.trim();
    }
  }

  // 5. Apply sanitization to fix common XML issues
  return sanitizeXML(xml);
}

/**
 * Fix common XML issues generated by AI:
 * - Unescaped & in attribute values (most common cause of parse errors)
 * - Ensure </mxfile> closing tag exists (truncation fix)
 */
function sanitizeXML(xml) {
  // Fix unescaped & that are NOT already part of valid XML entities.
  // Valid entities: &amp; &lt; &gt; &quot; &apos; &#123; &#x1A;
  xml = xml.replace(/&(?!amp;|lt;|gt;|quot;|apos;|#\d+;|#x[\da-fA-F]+;)/g, '&amp;');

  // Fix unescaped < and > inside attribute values (label="A < B" â†’ label="A &lt; B")
  // Strategy: process each attribute value and escape < > that appear inside
  xml = xml.replace(/((?:label|value|tooltip|placeholder)=")((?:[^"\\]|\\.)*)(")/g,
    function(match, prefix, val, suffix) {
      // Inside label/value attributes, escape < and > that aren't part of HTML tags
      // But draw.io labels can contain HTML like <br>, <b>, <font> â€” leave those alone
      // Only escape bare < > that would break XML parsing
      const fixed = val
        .replace(/<(?!\/?(?:br|b|i|u|font|div|span|p|hr|sub|sup|ul|ol|li|table|tr|td|th|img|a)\b[^>]*>)/gi, '&lt;')
        .replace(/(?<!<\/?(?:br|b|i|u|font|div|span|p|hr|sub|sup|ul|ol|li|table|tr|td|th|img|a)[^>]*)>/gi, '&gt;');
      return prefix + fixed + suffix;
    }
  );

  // If XML was truncated (no closing </mxfile>), try to close it
  if (xml.includes('<mxfile') && !xml.includes('</mxfile>')) {
    // Try to close all open tags
    if (!xml.includes('</root>'))          xml += '</root>';
    if (!xml.includes('</mxGraphModel>'))  xml += '</mxGraphModel>';
    if (!xml.includes('</diagram>'))       xml += '</diagram>';
    xml += '</mxfile>';
  }

  return xml;
}

/**
 * Validate XML with DOMParser.  Returns { valid: bool, error?: string }.
 */
function validateXML(xmlStr) {
  if (!xmlStr) return { valid: false, error: 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„ XML å…§å®¹' };
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlStr, 'application/xml');
  const errNode = doc.querySelector('parsererror');
  if (errNode) {
    // Grab the first meaningful line of the parser error
    const msg = errNode.textContent.trim().split('\n')
      .find(l => l.trim().length > 0) || errNode.textContent.trim();
    return { valid: false, error: msg };
  }
  if (!doc.querySelector('mxfile')) {
    return { valid: false, error: 'ç¼ºå°‘ <mxfile> æ ¹å…ƒç´ ï¼ŒXML çµæ§‹ä¸å®Œæ•´' };
  }
  return { valid: true };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Output Actions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function copyXML() {
  if (!generatedXML) return;
  const clean = cleanXML(generatedXML);
  navigator.clipboard.writeText(clean).then(() => {
    const btn = document.getElementById('btnCopy');
    btn.textContent = 'âœ“ å·²è¤‡è£½';
    setTimeout(() => { btn.textContent = 'è¤‡è£½ XML'; }, 2000);
  });
}

function downloadDrawio() {
  if (!generatedXML) return;
  const clean = cleanXML(generatedXML);
  const { valid, error: xmlErr } = validateXML(clean);
  if (!valid) {
    showGenStatus(`âš ï¸ XML é©—è­‰å¤±æ•—ï¼š${xmlErr}ã€‚ä»å˜—è©¦ä¸‹è¼‰ï¼Œå»ºè­°é‡æ–°ç”Ÿæˆã€‚`, 'warning');
  }
  const finalXML = clean || generatedXML;
  const blob = new Blob([finalXML], { type: 'application/octet-stream' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `aws-architecture-${new Date().toISOString().slice(0,10)}.drawio`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function previewInDrawio() {
  if (!generatedXML) return;
  const clean = cleanXML(generatedXML);
  const { valid, error: xmlErr } = validateXML(clean);
  if (!valid) {
    showGenStatus(`âš ï¸ XML é©—è­‰å¤±æ•—ç„¡æ³•é è¦½ï¼š${xmlErr}ã€‚è«‹é‡æ–°ç”Ÿæˆæˆ–ä¸‹è¼‰å¾Œæ‰‹å‹•ä¿®å¾©ã€‚`, 'warning');
    return;
  }

  // Open draw.io in embed mode and inject XML via postMessage API
  const xmlData = clean;
  const previewHtml = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>AWS æ¶æ§‹åœ–é è¦½</title>
<style>*{margin:0;padding:0}html,body,iframe{width:100%;height:100%;border:0;overflow:hidden}</style>
</head><body>
<iframe id="drawio" src="https://embed.diagrams.net/?embed=1&spin=1&proto=json&lightbox=1"></iframe>
<script>
const xml = ${JSON.stringify(xmlData)};
window.addEventListener('message', function handler(e) {
  try {
    const msg = JSON.parse(e.data);
    if (msg.event === 'init') {
      document.getElementById('drawio').contentWindow.postMessage(
        JSON.stringify({ action: 'load', xml: xml }), '*'
      );
    } else if (msg.event === 'load') {
      // Diagram loaded successfully
    } else if (msg.event === 'exit') {
      window.close();
    }
  } catch(_) {}
});
<\/script>
</body></html>`;

  const blob = new Blob([previewHtml], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  // Clean up blob URL after a delay
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
